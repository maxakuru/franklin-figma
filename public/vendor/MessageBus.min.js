var v=Object.defineProperty;var u=(i,e)=>v(i,"name",{value:e,configurable:!0});function _(i){if(typeof i!="object"||i===null)return i;if(Array.isArray(i))return i.map(_);let e=Object.getPrototypeOf(i),t=Object.keys(e).reduce((n,s)=>{try{n[s]=i[s]}catch(o){console.error("[messages/util] serialize() error: ",o)}return n},{});return Object.assign(Object.assign({},t),i)}u(_,"serialize");function M(i){return i.type.startsWith("__")&&i.type.endsWith("__")}u(M,"isPrivateMessage");var E=eval;function x(i){let e=E(i);return new Promise((t,n)=>{typeof e=="object"&&typeof e.then=="function"?e.then(s=>{t(s)}).catch(s=>{n(s)}):t(e)})}u(x,"exec");var B=function(i,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!s:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(i,t):s?s.value=t:e.set(i,t),t},r=function(i,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!n:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(i):n?n.value:e.get(i)},h,y,b,p,g,P=globalThis.DEV,F=globalThis.UI||globalThis.WIDGET||typeof figma>"u",$="https://www.figma.com",I=class{static{u(this,"MessageBus")}constructor(){h.set(this,void 0),y.set(this,{"selection:change":[],"currentpage:change":[],close:[],"ui:ready":[],"ui:init":[],"ui:change":[],"ui:close":[],"worker:ready":[],"worker:init":[],"drop:*":[]}),b.set(this,[]),p.set(this,0),g.set(this,{}),this._api={backend:new Proxy({},{get:(e,t,n)=>async(...s)=>{var o,a;let l=(B(this,p,(a=r(this,p,"f"),o=a++,a),"f"),o);console.log(`[MessageBus] _api(${s}) id='${l}'`);let c,d,f=new Promise((m,w)=>{c=m,d=w});return r(this,g,"f")[l]=[f,c,d],this._sendAPI("backend",{id:l,fn:t,args:s?JSON.stringify(s):void 0}),f}})},B(this,h,F,"f"),this._connect()}get isFrontend(){return r(this,h,"f")}get isBackend(){return!r(this,h,"f")}_connect(){r(this,h,"f")?window.addEventListener("message",this._incomingFrontend.bind(this)):figma.ui.onmessage=this._incomingBackend.bind(this)}async _incomingBackendInternal(e){let{type:t}=e,{payload:n}=e;if(t==="__execute__"||t.startsWith("__api_")){let{id:s,fn:o,args:a}=n,l=typeof a=="object"?a:a?JSON.parse(a):{};if(console.log(`[MessageBus] _incomingBackendInternal(${t}) id=${s}`),o)if(t==="__execute__"){let d=`(${new Function("figma",...Object.keys(l),`return (${o})(figma);`)}).call(null, figma, ...${JSON.stringify(Object.values(l))});`;x(d).then(f=>{this._sendExecute({id:s,ret:_(f)})}).catch(f=>{this._sendExecute({id:s,error:f})})}else try{let c=await globalThis.api[o].apply(null,l);this._sendAPI("backend",{id:s,ret:_(c)})}catch(c){console.error("[MessageBus]  _incomingBackendInternal() global api error: ",c),this._sendAPI("backend",{id:s,error:c})}else{let{ret:c,error:d}=n,[f,m,w]=r(this,g,"f")[s];d?w(d):m(c),delete r(this,g,"f")[s]}}}_incomingBackend(e,t){M(e)?this._incomingBackendInternal(e):this._incoming(e)}_incomingFrontendInternal(e){let{type:t}=e,{payload:n}=e;if(t==="__execute__"||t.startsWith("__api_")){let{id:s,fn:o,args:a}=n,l=typeof a=="object"?a:a?JSON.parse(a):{};if(console.log(`[MessageBus] _incomingFrontendInternal(${l}) id=${s}`),o){let d=`(${new Function("window",...Object.keys(l),`return (${o})(window);`)}).call(null, window, ...${JSON.stringify(Object.values(l))});`;x(d).then(f=>{this._sendExecute({id:s,ret:_(f)})}).catch(f=>{this._sendExecute({id:s,error:f})})}else{let{ret:c,error:d}=n,[f,m,w]=r(this,g,"f")[s];d?w(d):m(c),delete r(this,g,"f")[s]}}}_incomingFrontend({data:e}){let{pluginMessage:t}=e,{figmaMessage:n}=e;n?console.debug("[MessageBus] unhandled figmaMessage: ",n):M(t)?this._incomingFrontendInternal(t):this._incoming(t)}_incoming(e){if(!e.type){console.error("[MessageBus] Invalid message: ",e);return}let t=r(this,y,"f")[e.type];t&&(t.forEach(n=>{n&&n.call(null,e.payload)}),r(this,b,"f").forEach(n=>{n&&n.call(null,e.type,e.payload)}))}_sendExecute(e){this._send("__execute__",e)}_sendAPI(e,t){this._send(`__api_${e}__`,t)}execute(e,t){var n,s;let o=(B(this,p,(s=r(this,p,"f"),n=s++,s),"f"),n);console.log(`[MessageBus] execute(${t}) id='${o}'`);let a,l,c=new Promise((d,f)=>{a=d,l=f});return r(this,g,"f")[o]=[c,a,l],this._sendExecute({id:o,fn:e.toString(),args:t?JSON.stringify(t):void 0}),c}get api(){let e=this._api,t=r(this,h,"f")?"frontend":"backend";try{Object.defineProperty(e,t,{get:()=>{throw Error(`cannot access ${t} API from ${t}`)}})}catch{}return e}send(e,t){this._send(e,t)}sendAll(e,t){this._send(e,t),r(this,h,"f")?this._incomingFrontend({data:{pluginMessage:{type:e,payload:t}}}):this._incomingBackend({type:e,payload:t})}_send(e,t){try{r(this,h,"f")?(console.log(`[MessageBus] _send(frontend) type='${e}'`),parent.postMessage({pluginMessage:{type:e,payload:t},pluginId:globalThis.PLUGIN_ID},P?"*":$)):(console.log(`[MessageBus] _send(backend) type='${e}'`),figma.ui.postMessage({type:e,payload:t},{origin:P?"*":globalThis.UI_ENDPOINT}))}catch(n){typeof n=="object"&&typeof n.message=="string"&&n.message.includes("No UI to send a message to")?(console.error("[MessageBus] Error, UI is closed during send: ",r(this,h,"f")),this._incomingBackend({type:"ui:close",payload:void 0},void 0)):console.error("[MessageBus] Error sending message: ",n)}}once(e,t){let n,s=u(o=>{t.call(null,o),n()},"wrap");n=this.on(e,s)}on(e,t){let n;if(e==="*"?n=r(this,b,"f"):n=r(this,y,"f")[e],!n)return()=>{};let s=n.push(t);return()=>{n[s-1]=void 0}}};h=new WeakMap,y=new WeakMap,b=new WeakMap,p=new WeakMap,g=new WeakMap;var k=new I;var j=k;var V=j;export{V as default,_ as serialize};
