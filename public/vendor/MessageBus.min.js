var I=Object.defineProperty;var h=(i,e)=>I(i,"name",{value:e,configurable:!0});function g(i){if(typeof i!="object"||i===null)return i;if(Array.isArray(i))return i.map(g);let e=Object.getPrototypeOf(i),n=Object.keys(e).reduce((t,s)=>{try{t[s]=i[s]}catch(o){console.error("[messages/util] serialize() error: ",o)}return t},{});return Object.assign(Object.assign({},n),i)}h(g,"serialize");function x(i){return i.type.startsWith("__")&&i.type.endsWith("__")}h(x,"isPrivateMessage");var P=eval;function E(i){let e=P(i);return new Promise((n,t)=>{typeof e=="object"&&typeof e.then=="function"?e.then(s=>{n(s)}).catch(s=>{t(s)}):n(e)})}h(E,"exec");var M=function(i,e,n,t,s){if(t==="m")throw new TypeError("Private method is not writable");if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!s:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t==="a"?s.call(i,n):s?s.value=n:e.set(i,n),n},r=function(i,e,n,t){if(n==="a"&&!t)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!t:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?t:n==="a"?t.call(i):t?t.value:e.get(i)},l,p,m,w,u,v=globalThis.DEV,B=globalThis.UI||globalThis.WIDGET||typeof figma=="undefined",k="https://www.figma.com",y=class{constructor(){l.set(this,void 0),p.set(this,{"selection:change":[],"currentpage:change":[],close:[],"ui:ready":[],"ui:init":[],"ui:close":[],"worker:ready":[],"worker:init":[],"drop:*":[]}),m.set(this,[]),w.set(this,0),u.set(this,{}),M(this,l,B,"f"),this._connect()}get isFrontend(){return r(this,l,"f")}get isBackend(){return!r(this,l,"f")}_connect(){r(this,l,"f")?window.addEventListener("message",this._incomingFrontend.bind(this)):figma.ui.onmessage=this._incomingBackend.bind(this)}_incomingBackendInternal(e){let{type:n}=e,{payload:t}=e;if(n==="__execute__"){let{id:s,fn:o,args:d={}}=t;if(o){let a=`(${new Function("figma",...Object.keys(d),`return (${o})(figma);`)}).call(null, figma, ...${JSON.stringify(Object.values(d))});`;E(a).then(c=>{this._sendExecute({id:s,ret:g(c)})}).catch(c=>{this._sendExecute({id:s,error:c})})}else{let{ret:f,error:a}=t,[c,_,b]=r(this,u,"f")[s];a?b(a):_(f),delete r(this,u,"f")[s]}}}_incomingBackend(e,n){x(e)?this._incomingBackendInternal(e):this._incoming(e)}_incomingFrontendInternal(e){let{type:n}=e,{payload:t}=e;if(n==="__execute__"){let{id:s,fn:o,args:d={}}=t;if(o){let a=`(${new Function("window",...Object.keys(d),`return (${o})(window);`)}).call(null, window, ...${JSON.stringify(Object.values(d))});`;E(a).then(c=>{this._sendExecute({id:s,ret:g(c)})}).catch(c=>{this._sendExecute({id:s,error:c})})}else{let{ret:f,error:a}=t,[c,_,b]=r(this,u,"f")[s];a?b(a):_(f),delete r(this,u,"f")[s]}}}_incomingFrontend({data:e}){let{pluginMessage:n}=e;x(n)?this._incomingFrontendInternal(n):this._incoming(n)}_incoming(e){if(!e.type){console.error("[MessageBus] Invalid message: ",e);return}let n=r(this,p,"f")[e.type];!n||(n.forEach(t=>{!t||t.call(null,e.payload)}),r(this,m,"f").forEach(t=>{!t||t.call(null,e.type,e.payload)}))}_sendExecute(e){this._send("__execute__",e)}execute(e,n){var t,s;let o=(M(this,w,(s=r(this,w,"f"),t=s++,s),"f"),t);this._sendExecute({id:o,fn:e.toString(),args:n});let d,f,a=new Promise((c,_)=>{d=c,f=_});return r(this,u,"f")[o]=[a,d,f],a}send(e,n){this._send(e,n)}sendAll(e,n){this._send(e,n),r(this,l,"f")?this._incomingFrontend({data:{pluginMessage:{type:e,payload:n}}}):this._incomingBackend({type:e,payload:n})}_send(e,n){try{r(this,l,"f")?parent.postMessage({pluginMessage:{type:e,payload:n},pluginId:globalThis.PLUGIN_ID},v?"*":k):figma.ui.postMessage({type:e,payload:n},{origin:v?"*":globalThis.UI_ENDPOINT})}catch(t){typeof t=="object"&&typeof t.message=="string"&&t.message.includes("No UI to send a message to")?(console.error("[MessageBus] Error, UI is closed during send: ",r(this,l,"f")),this._incomingBackend({type:"ui:close",payload:void 0},void 0)):console.error("[MessageBus] Error sending message: ",t)}}once(e,n){let t,s=h(o=>{n.call(null,o),t()},"wrap");t=this.on(e,s)}on(e,n){let t;if(e==="*"?t=r(this,m,"f"):t=r(this,p,"f")[e],!t)return()=>{};let s=t.push(n);return()=>{t[s-1]=void 0}}};h(y,"MessageBus"),l=new WeakMap,p=new WeakMap,m=new WeakMap,w=new WeakMap,u=new WeakMap;var F=new y;var j=F;var C=j;export{C as default,g as serialize};
