var I=Object.defineProperty;var h=(i,e)=>I(i,"name",{value:e,configurable:!0});function _(i){if(typeof i!="object"||i===null)return i;if(Array.isArray(i))return i.map(_);let e=Object.getPrototypeOf(i),n=Object.keys(e).reduce((t,s)=>{try{t[s]=i[s]}catch(r){console.error("[messages/util] serialize() error: ",r)}return t},{});return Object.assign(Object.assign({},n),i)}h(_,"serialize");function x(i){return i.type.startsWith("__")&&i.type.endsWith("__")}h(x,"isPrivateMessage");var k=eval;function M(i){let e=k(i);return new Promise((n,t)=>{typeof e=="object"&&typeof e.then=="function"?e.then(s=>{n(s)}).catch(s=>{t(s)}):n(e)})}h(M,"exec");var E=function(i,e,n,t,s){if(t==="m")throw new TypeError("Private method is not writable");if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!s:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t==="a"?s.call(i,n):s?s.value=n:e.set(i,n),n},o=function(i,e,n,t){if(n==="a"&&!t)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!t:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?t:n==="a"?t.call(i):t?t.value:e.get(i)},f,p,m,w,g,F=globalThis.DEV,O=globalThis.UI||globalThis.WIDGET||typeof figma>"u",P="https://www.figma.com",B=class{static{h(this,"MessageBus")}constructor(){f.set(this,void 0),p.set(this,{"selection:change":[],"currentpage:change":[],close:[],"ui:ready":[],"ui:init":[],"ui:close":[],"worker:ready":[],"worker:init":[],"drop:*":[]}),m.set(this,[]),w.set(this,0),g.set(this,{}),E(this,f,O,"f"),this._connect()}get isFrontend(){return o(this,f,"f")}get isBackend(){return!o(this,f,"f")}_connect(){o(this,f,"f")?window.addEventListener("message",this._incomingFrontend.bind(this)):figma.ui.onmessage=this._incomingBackend.bind(this)}_incomingBackendInternal(e){let{type:n}=e,{payload:t}=e;if(n==="__execute__"){let{id:s,fn:r,args:a}=t,d=typeof a=="object"?a:a?JSON.parse(a):{};if(console.log(`[MessageBus] _incomingBackendInternal(${d}) id=${s}`),r){let c=`(${new Function("figma",...Object.keys(d),`return (${r})(figma);`)}).call(null, figma, ...${JSON.stringify(Object.values(d))});`;M(c).then(l=>{this._sendExecute({id:s,ret:_(l)})}).catch(l=>{this._sendExecute({id:s,error:l})})}else{let{ret:u,error:c}=t,[l,y,b]=o(this,g,"f")[s];c?b(c):y(u),delete o(this,g,"f")[s]}}}_incomingBackend(e,n){x(e)?this._incomingBackendInternal(e):this._incoming(e)}_incomingFrontendInternal(e){let{type:n}=e,{payload:t}=e;if(n==="__execute__"){let{id:s,fn:r,args:a}=t,d=typeof a=="object"?a:a?JSON.parse(a):{};if(console.log(`[MessageBus] _incomingFrontendInternal(${d}) id=${s}`),r){let c=`(${new Function("window",...Object.keys(d),`return (${r})(window);`)}).call(null, window, ...${JSON.stringify(Object.values(d))});`;M(c).then(l=>{this._sendExecute({id:s,ret:_(l)})}).catch(l=>{this._sendExecute({id:s,error:l})})}else{let{ret:u,error:c}=t,[l,y,b]=o(this,g,"f")[s];c?b(c):y(u),delete o(this,g,"f")[s]}}}_incomingFrontend({data:e}){let{pluginMessage:n}=e;x(n)?this._incomingFrontendInternal(n):this._incoming(n)}_incoming(e){if(!e.type){console.error("[MessageBus] Invalid message: ",e);return}let n=o(this,p,"f")[e.type];n&&(n.forEach(t=>{t&&t.call(null,e.payload)}),o(this,m,"f").forEach(t=>{t&&t.call(null,e.type,e.payload)}))}_sendExecute(e){this._send("__execute__",e)}execute(e,n){var t,s;let r=(E(this,w,(s=o(this,w,"f"),t=s++,s),"f"),t);console.log(`[MessageBus] execute(${n}) id='${r}'`),this._sendExecute({id:r,fn:e.toString(),args:n?JSON.stringify(n):void 0});let a,d,u=new Promise((c,l)=>{a=c,d=l});return o(this,g,"f")[r]=[u,a,d],u}send(e,n){this._send(e,n)}sendAll(e,n){this._send(e,n),o(this,f,"f")?this._incomingFrontend({data:{pluginMessage:{type:e,payload:n}}}):this._incomingBackend({type:e,payload:n})}_send(e,n){try{o(this,f,"f")?(console.log(`[MessageBus] _send(frontend) type='${e}'`),parent.postMessage({pluginMessage:{type:e,payload:n},pluginId:globalThis.PLUGIN_ID},F?"*":P)):(console.log(`[MessageBus] _send(backend) type='${e}'`),figma.ui.postMessage({type:e,payload:n},{origin:F?"*":globalThis.UI_ENDPOINT}))}catch(t){typeof t=="object"&&typeof t.message=="string"&&t.message.includes("No UI to send a message to")?(console.error("[MessageBus] Error, UI is closed during send: ",o(this,f,"f")),this._incomingBackend({type:"ui:close",payload:void 0},void 0)):console.error("[MessageBus] Error sending message: ",t)}}once(e,n){let t,s=h(r=>{n.call(null,r),t()},"wrap");t=this.on(e,s)}on(e,n){let t;if(e==="*"?t=o(this,m,"f"):t=o(this,p,"f")[e],!t)return()=>{};let s=t.push(n);return()=>{t[s-1]=void 0}}};f=new WeakMap,p=new WeakMap,m=new WeakMap,w=new WeakMap,g=new WeakMap;var j=new B;var v=j;var V=v;export{V as default,_ as serialize};
